// prisma/schema.prisma

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL") // pool (PgBouncer)
  directUrl = env("DIRECT_URL") // conexi√≥n directa
}

generator client {
  provider = "prisma-client-js"
}

model Agency {
  id_agency            Int                    @id @default(autoincrement())
  name                 String
  legal_name           String
  address              String?
  phone                String?
  phones               String[]               @default([])
  email                String?
  social               Json?
  tax_id               String
  website              String?
  foundation_date      DateTime?
  logo_url             String?
  afip_cert_base64     String?
  afip_key_base64      String?
  transfer_fee_pct     Decimal?               @db.Decimal(9, 6)
  creation_date        DateTime               @default(now())
  users                User[]
  bookings             Booking[]
  Client               Client[]
  SalesTeam            SalesTeam[]
  Resources            Resources[]
  Operator             Operator[]
  investments          Investment[]
  TextPreset           TextPreset[]
  CommissionRuleSet    CommissionRuleSet[]
  templateConfigs      TemplateConfig[]
  FinanceCurrency      FinanceCurrency[]
  FinanceAccount       FinanceAccount[]
  FinancePaymentMethod FinancePaymentMethod[]
  ExpenseCategory      ExpenseCategory[]
  FinanceConfig        FinanceConfig?
  Lead                 Lead[]
  Receipt              Receipt[]
  ServiceType          ServiceType[]
  ServiceCalcConfig    ServiceCalcConfig?
  creditAccounts       CreditAccount[]
  creditEntries        CreditEntry[]
}

// User: renombramos las colecciones para que reflejen la intenci√≥n
model User {
  id_user       Int      @id @default(autoincrement())
  email         String   @unique
  password      String
  role          String
  position      String?
  first_name    String
  last_name     String
  creation_date DateTime @default(now())
  id_agency     Int
  agency        Agency   @relation(fields: [id_agency], references: [id_agency], onDelete: Cascade)

  bookings                 Booking[]
  sales_teams              UserTeam[]
  clients                  Client[]
  CalendarNote             CalendarNote[]
  investmentsAsBeneficiary Investment[]        @relation("InvestmentUser")
  investmentsCreated       Investment[]        @relation("InvestmentCreatedBy")
  TextPreset               TextPreset[]
  CommissionRuleSet        CommissionRuleSet[]
  CommissionShare          CommissionShare[]

  // üëá Relaciones nuevas y con nombre sim√©trico:
  createdDestinations      Destination[]        @relation("DestinationCreatedBy")
  serviceDestinationsAdded ServiceDestination[] @relation("ServiceDestinationAddedBy")
  creditEntries            CreditEntry[]
}

model Client {
  id_client              Int             @id @default(autoincrement())
  first_name             String
  last_name              String
  phone                  String
  address                String?
  postal_code            String?
  locality               String?
  company_name           String?
  tax_id                 String?
  commercial_address     String?
  dni_number             String?
  passport_number        String?
  birth_date             DateTime
  nationality            String
  gender                 String
  email                  String?
  nationality_country_id Int?
  nationalityCountry     Country?        @relation(fields: [nationality_country_id], references: [id_country])
  registration_date      DateTime        @default(now())
  id_agency              Int
  agency                 Agency          @relation(fields: [id_agency], references: [id_agency], onDelete: Cascade)
  id_user                Int
  user                   User            @relation(fields: [id_user], references: [id_user], onDelete: Cascade)
  bookings               Booking[]       @relation("BookingClients")
  titular_bookings       Booking[]       @relation("Titular")
  invoices               Invoice[]       @relation("ClientInvoices")
  ClientPayment          ClientPayment[]
  creditAccounts         CreditAccount[]
}

model Booking {
  id_booking          Int             @id @default(autoincrement())
  clientStatus        String          @map("client_status")
  operatorStatus      String          @map("operator_status")
  status              String
  details             String
  invoice_type        String
  invoice_observation String?
  observation         String?
  creation_date       DateTime        @default(now())
  id_user             Int
  user                User            @relation(fields: [id_user], references: [id_user])
  id_agency           Int
  agency              Agency          @relation(fields: [id_agency], references: [id_agency])
  titular_id          Int
  titular             Client          @relation("Titular", fields: [titular_id], references: [id_client])
  clients             Client[]        @relation("BookingClients")
  services            Service[]
  departure_date      DateTime
  return_date         DateTime
  pax_count           Int
  invoices            Invoice[]       @relation("BookingInvoices")
  Receipt             Receipt[]       @relation("BookingReceipt")
  investments         Investment[]    @relation("BookingInvestments")
  OperatorDue         OperatorDue[]
  ClientPayment       ClientPayment[]
  creditEntries       CreditEntry[]

  @@index([id_agency, id_booking], name: "agency_booking_idx")
}

model Service {
  id_service                Int                  @id @default(autoincrement())
  type                      String
  description               String
  note                      String?
  sale_price                Float
  cost_price                Float
  destination               String
  reference                 String
  tax_21                    Float?
  tax_105                   Float?
  exempt                    Float?
  other_taxes               Float?
  currency                  String
  nonComputable             Float?
  taxableBase21             Float?
  taxableBase10_5           Float?
  commissionExempt          Float?
  commission21              Float?
  commission10_5            Float?
  vatOnCommission21         Float?
  vatOnCommission10_5       Float?
  totalCommissionWithoutVAT Float?
  impIVA                    Float?
  card_interest             Float?
  card_interest_21          Float?
  taxableCardInterest       Float?
  vatOnCardInterest         Float?
  transfer_fee_pct          Decimal?             @db.Decimal(9, 6)
  transfer_fee_amount       Decimal?             @db.Decimal(14, 2)
  departure_date            DateTime
  return_date               DateTime
  ServiceDestination        ServiceDestination[] // ‚Üê NUEVO (para includes)
  created_at                DateTime             @default(now())
  booking_id                Int
  booking                   Booking              @relation(fields: [booking_id], references: [id_booking], onDelete: Cascade)
  id_operator               Int
  operator                  Operator             @relation(fields: [id_operator], references: [id_operator], onDelete: Cascade)
  InvoiceItem               InvoiceItem[]
  OperatorDue               OperatorDue[]
}

// ===================== NUEVO =====================
model Country {
  id_country  Int           @id @default(autoincrement())
  name        String
  iso2        String        @unique // AR, US, MX...
  iso3        String?
  slug        String        @unique // "argentina", "estados-unidos"
  enabled     Boolean       @default(true)
  created_at  DateTime      @default(now())
  updated_at  DateTime      @updatedAt
  Destination Destination[]
  Client      Client[]
}

// Destination: vincula al creador con nombre de relaci√≥n
model Destination {
  id_destination Int      @id @default(autoincrement())
  name           String
  slug           String
  alt_names      String[] @default([])
  popularity     Int      @default(0)
  enabled        Boolean  @default(true)

  country_id Int
  country    Country @relation(fields: [country_id], references: [id_country], onDelete: Restrict)

  created_by Int?
  createdBy  User? @relation("DestinationCreatedBy", fields: [created_by], references: [id_user])

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  ServiceDestination ServiceDestination[]

  @@unique([country_id, slug], name: "country_id_slug")
  @@index([popularity])
  @@index([enabled])
  // (opcional, recomendados sin extensiones)
  @@index([slug])
  @@index([country_id, slug])
}

// ServiceDestination: una sola relaci√≥n a User (addedBy), sin "User/userId_user" extra
model ServiceDestination {
  service_id     Int
  destination_id Int

  service     Service     @relation(fields: [service_id], references: [id_service], onDelete: Cascade)
  destination Destination @relation(fields: [destination_id], references: [id_destination], onDelete: Restrict)

  added_by Int?
  addedBy  User?    @relation("ServiceDestinationAddedBy", fields: [added_by], references: [id_user])
  added_at DateTime @default(now())

  @@id([service_id, destination_id])
  @@index([service_id])
  @@index([destination_id])
}

model Operator {
  id_operator       Int             @id @default(autoincrement())
  name              String
  email             String?
  phone             String?
  website           String?
  address           String?
  postal_code       String?
  city              String?
  state             String?
  country           String?
  vat_status        String?
  legal_name        String?
  tax_id            String?
  registration_date DateTime        @default(now())
  credit_balance    Float           @default(0)
  debit_balance     Float           @default(0)
  services          Service[]
  id_agency         Int
  agency            Agency          @relation(fields: [id_agency], references: [id_agency], onDelete: Cascade)
  Investment        Investment[]
  creditAccounts    CreditAccount[]
}

model Invoice {
  id_invoice        Int           @id @default(autoincrement())
  invoice_number    String        @unique
  issue_date        DateTime      @default(now())
  total_amount      Float
  currency          String
  status            String
  type              String
  recipient         String
  facturaHtml       String?
  payloadAfip       Json?
  bookingId_booking Int
  booking           Booking       @relation("BookingInvoices", fields: [bookingId_booking], references: [id_booking])
  client_id         Int
  client            Client        @relation("ClientInvoices", fields: [client_id], references: [id_client])
  credit_notes      CreditNote[]
  InvoiceItem       InvoiceItem[]
}

model InvoiceItem {
  id                  Int      @id @default(autoincrement())
  invoiceId           Int
  invoice             Invoice  @relation(fields: [invoiceId], references: [id_invoice], onDelete: Cascade)
  serviceId           Int?
  service             Service? @relation(fields: [serviceId], references: [id_service])
  description         String
  sale_price          Float
  taxableBase21       Float
  commission21        Float
  tax_21              Float
  vatOnCommission21   Float
  taxableBase10_5     Float?
  commission10_5      Float?
  tax_105             Float?
  vatOnCommission10_5 Float?
  taxableCardInterest Float?
  vatOnCardInterest   Float?
}

model CreditNote {
  id_credit_note Int              @id @default(autoincrement())
  credit_number  String           @unique
  issue_date     DateTime         @default(now())
  total_amount   Float
  currency       String
  status         String
  type           String
  recipient      String
  payloadAfip    Json?
  invoiceId      Int
  invoice        Invoice          @relation(fields: [invoiceId], references: [id_invoice])
  items          CreditNoteItem[]
}

model CreditNoteItem {
  id                  Int        @id @default(autoincrement())
  creditNoteId        Int
  creditNote          CreditNote @relation(fields: [creditNoteId], references: [id_credit_note], onDelete: Cascade)
  serviceId           Int?
  description         String
  sale_price          Float
  taxableBase21       Float
  commission21        Float
  tax_21              Float
  vatOnCommission21   Float
  taxableBase10_5     Float?
  commission10_5      Float?
  tax_105             Float?
  vatOnCommission10_5 Float?
  taxableCardInterest Float?
  vatOnCardInterest   Float?
}

model SalesTeam {
  id_team    Int        @id @default(autoincrement())
  name       String
  user_teams UserTeam[]
  id_agency  Int
  agency     Agency     @relation(fields: [id_agency], references: [id_agency], onDelete: Cascade)
}

model UserTeam {
  id_user_team Int       @id @default(autoincrement())
  id_user      Int
  id_team      Int
  user         User      @relation(fields: [id_user], references: [id_user])
  sales_team   SalesTeam @relation(fields: [id_team], references: [id_team], onDelete: Cascade)
}

model Receipt {
  id_receipt     Int      @id @default(autoincrement())
  receipt_number String   @unique
  issue_date     DateTime @default(now())

  // Neto que entra a la agencia (se mantiene igual)
  amount          Float
  amount_string   String
  amount_currency String

  // NUEVO: costo financiero del medio de pago
  /// Monto que paga el cliente pero retiene el medio de pago
  /// (intereses de tarjeta, comisiones de MP/bancos, etc.).
  /// Misma moneda que amount_currency.
  payment_fee_amount Decimal? @db.Decimal(18, 2)

  concept           String
  currency          String
  payment_method    String?
  account           String?
  base_amount       Decimal? @db.Decimal(18, 2)
  base_currency     String?
  counter_amount    Decimal? @db.Decimal(18, 2)
  counter_currency  String?
  payment_method_id Int?
  account_id        Int?

  payments          ReceiptPayment[]
  bookingId_booking Int?
  booking           Booking?         @relation("BookingReceipt", fields: [bookingId_booking], references: [id_booking], onDelete: SetNull)
  id_agency         Int?
  agency            Agency?          @relation(fields: [id_agency], references: [id_agency], onDelete: SetNull)
  serviceIds        Int[]
  clientIds         Int[]            @default([])
  creditEntries     CreditEntry[]

  @@index([bookingId_booking])
  @@index([id_agency])
}

model ReceiptPayment {
  id_receipt_payment Int     @id @default(autoincrement())
  receipt_id         Int
  amount             Decimal @db.Decimal(18, 2)

  payment_method_id Int
  account_id        Int?

  receipt Receipt @relation(fields: [receipt_id], references: [id_receipt], onDelete: Cascade)

  @@index([receipt_id])
}

model Resources {
  id_resource Int      @id @default(autoincrement())
  createdAt   DateTime @default(now())
  title       String
  description String?
  id_agency   Int
  agency      Agency   @relation(fields: [id_agency], references: [id_agency], onDelete: Cascade)
}

model CalendarNote {
  id        Int      @id @default(autoincrement())
  title     String
  content   String
  date      DateTime
  createdBy Int
  creator   User     @relation(fields: [createdBy], references: [id_user], onDelete: Cascade)
  createdAt DateTime @default(now())
}

model Investment {
  id_investment    Int           @id @default(autoincrement())
  id_agency        Int
  agency           Agency        @relation(fields: [id_agency], references: [id_agency], onDelete: Cascade)
  category         String
  description      String
  amount           Decimal       @db.Decimal(18, 2)
  currency         String
  created_at       DateTime      @default(now())
  paid_at          DateTime?
  payment_method   String?
  account          String?
  base_amount      Decimal?      @db.Decimal(18, 2)
  base_currency    String?
  counter_amount   Decimal?      @db.Decimal(18, 2)
  counter_currency String?
  operator_id      Int?
  operator         Operator?     @relation(fields: [operator_id], references: [id_operator])
  user_id          Int?
  user             User?         @relation("InvestmentUser", fields: [user_id], references: [id_user])
  created_by       Int
  createdBy        User          @relation("InvestmentCreatedBy", fields: [created_by], references: [id_user])
  booking_id       Int?
  booking          Booking?      @relation("BookingInvestments", fields: [booking_id], references: [id_booking], onDelete: SetNull)
  creditEntries    CreditEntry[]

  @@index([id_agency, category])
  @@index([created_at])
  @@index([paid_at])
  @@index([booking_id])
}

model OperatorDue {
  id_due        Int           @id @default(autoincrement())
  created_at    DateTime      @default(now())
  booking_id    Int
  booking       Booking       @relation(fields: [booking_id], references: [id_booking], onDelete: Cascade)
  service_id    Int
  service       Service       @relation(fields: [service_id], references: [id_service], onDelete: Cascade)
  due_date      DateTime
  concept       String
  status        String
  amount        Decimal       @db.Decimal(18, 2)
  currency      String
  creditEntries CreditEntry[]

  @@index([booking_id])
  @@index([service_id])
  @@index([due_date])
}

model ClientPayment {
  id_payment Int      @id @default(autoincrement())
  created_at DateTime @default(now())
  booking_id Int
  booking    Booking  @relation(fields: [booking_id], references: [id_booking], onDelete: Cascade)
  client_id  Int
  client     Client   @relation(fields: [client_id], references: [id_client])
  amount     Decimal  @db.Decimal(18, 2)
  currency   String
  due_date   DateTime

  @@index([booking_id])
  @@index([client_id])
}

model TemplateConfig {
  id_template Int      @id @default(autoincrement())
  id_agency   Int
  agency      Agency   @relation(fields: [id_agency], references: [id_agency], onDelete: Cascade)
  doc_type    String
  config      Json
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt

  @@unique([id_agency, doc_type])
  @@index([id_agency])
}

model TextPreset {
  id_preset Int    @id @default(autoincrement())
  title     String // nombre visible de la idea/maqueta
  content   String // el texto a insertar (quote.dateRange o confirmation.servicesText)
  doc_type  String // "quote" | "confirmation"
  data      Json?

  id_user Int
  user    User @relation(fields: [id_user], references: [id_user], onDelete: Cascade)

  id_agency Int
  agency    Agency @relation(fields: [id_agency], references: [id_agency], onDelete: Cascade)

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  @@unique([id_user, doc_type, title])
  @@index([id_user, doc_type, created_at])
}

model CommissionRuleSet {
  id_rule_set Int    @id @default(autoincrement())
  id_agency   Int
  agency      Agency @relation(fields: [id_agency], references: [id_agency], onDelete: Cascade)

  owner_user_id Int
  owner         User @relation(fields: [owner_user_id], references: [id_user], onDelete: Cascade)

  valid_from DateTime @default(now())

  own_pct Decimal @db.Decimal(5, 2)

  shares CommissionShare[]

  @@index([id_agency, owner_user_id, valid_from])
}

model CommissionShare {
  id_share    Int               @id @default(autoincrement())
  rule_set_id Int
  ruleSet     CommissionRuleSet @relation(fields: [rule_set_id], references: [id_rule_set], onDelete: Cascade)

  beneficiary_user_id Int
  beneficiary         User @relation(fields: [beneficiary_user_id], references: [id_user], onDelete: Cascade)

  percent Decimal @db.Decimal(5, 2)

  @@unique([rule_set_id, beneficiary_user_id])
}

model FinanceConfig {
  id_config Int    @id @default(autoincrement())
  id_agency Int    @unique
  agency    Agency @relation(fields: [id_agency], references: [id_agency], onDelete: Cascade)

  default_currency_code                 String
  hide_operator_expenses_in_investments Boolean @default(false)

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  @@index([id_agency])
}

model FinanceCurrency {
  id_currency Int    @id @default(autoincrement())
  id_agency   Int
  agency      Agency @relation(fields: [id_agency], references: [id_agency], onDelete: Cascade)

  code       String // ARS, USD
  name       String // Pesos, D√≥lares
  symbol     String?
  decimals   Int     @default(2)
  is_primary Boolean @default(false)

  enabled     Boolean @default(true)
  sort_order  Int     @default(0)
  lock_system Boolean @default(false)

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  @@unique([id_agency, code])
  @@index([id_agency, enabled])
}

model FinanceAccount {
  id_account Int    @id @default(autoincrement())
  id_agency  Int
  agency     Agency @relation(fields: [id_agency], references: [id_agency], onDelete: Cascade)

  name     String
  type     String? // bank | wallet | cash (texto libre v1)
  alias    String?
  cbu      String?
  currency String? // opcional

  enabled     Boolean @default(true)
  sort_order  Int     @default(0)
  lock_system Boolean @default(false)

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  @@unique([id_agency, name])
  @@index([id_agency, enabled])
}

model FinancePaymentMethod {
  id_method Int    @id @default(autoincrement())
  id_agency Int
  agency    Agency @relation(fields: [id_agency], references: [id_agency], onDelete: Cascade)

  name             String // Efectivo, Transferencia...
  code             String // cash, transfer, credit...
  requires_account Boolean @default(false)

  enabled     Boolean @default(true)
  sort_order  Int     @default(0)
  lock_system Boolean @default(false)

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  @@unique([id_agency, code])
  @@unique([id_agency, name])
  @@index([id_agency, enabled])
}

model ExpenseCategory {
  id_category Int    @id @default(autoincrement())
  id_agency   Int
  agency      Agency @relation(fields: [id_agency], references: [id_agency], onDelete: Cascade)

  name              String // "SUELDO", "COMISION", "OPERADOR", etc.
  code              String? // opcional: sueldo | comision | operador | ...
  requires_operator Boolean @default(false)
  requires_user     Boolean @default(false)

  enabled     Boolean @default(true)
  sort_order  Int     @default(0)
  lock_system Boolean @default(false)

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  @@unique([id_agency, name])
  @@index([id_agency, enabled])
}

model ServiceType {
  id_service_type Int    @id @default(autoincrement())
  id_agency       Int
  agency          Agency @relation(fields: [id_agency], references: [id_agency], onDelete: Cascade)

  code    String // slug √∫nico por agencia (ej: "aereos-nacional")
  name    String // nombre visible (ej: "A√©reos Nacional")
  enabled Boolean @default(true)

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  @@unique([id_agency, code])
  @@unique([id_agency, name])
  @@index([id_agency, enabled])
}

model ServiceCalcConfig {
  id_config Int    @id @default(autoincrement())
  id_agency Int    @unique
  agency    Agency @relation(fields: [id_agency], references: [id_agency], onDelete: Cascade)

  // "auto" para usar BillingBreakdown; "manual" para cargar importes simples
  billing_breakdown_mode String @default("auto")

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  @@index([id_agency])
}

// ===========================
// Leads (landing > contacto)
// ===========================

model Lead {
  id_lead Int @id @default(autoincrement())

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  // Datos del formulario p√∫blico
  full_name   String
  agency_name String
  role        String
  team_size   String?
  location    String?
  email       String
  whatsapp    String?
  message     String? @db.Text
  status      String  @default("PENDING")

  contacted_at DateTime?
  source       String    @default("landing")

  id_agency Int?
  agency    Agency? @relation(fields: [id_agency], references: [id_agency], onDelete: SetNull)

  @@index([status])
  @@index([created_at])
  @@index([email])
}

model CreditAccount {
  id_credit_account Int    @id @default(autoincrement())
  id_agency         Int
  agency            Agency @relation(fields: [id_agency], references: [id_agency], onDelete: Cascade)

  operator_id Int?
  operator    Operator? @relation(fields: [operator_id], references: [id_operator], onDelete: Cascade)
  client_id   Int?
  client      Client?   @relation(fields: [client_id], references: [id_client], onDelete: Cascade)

  currency String
  balance  Decimal @default(0) @db.Decimal(18, 2)

  enabled    Boolean  @default(true)
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  entries CreditEntry[]

  @@index([id_agency])
  @@index([operator_id])
  @@index([client_id])
  @@index([currency])
}

model CreditEntry {
  id_entry  Int    @id @default(autoincrement())
  id_agency Int
  agency    Agency @relation(fields: [id_agency], references: [id_agency], onDelete: Cascade)

  account_id Int
  account    CreditAccount @relation(fields: [account_id], references: [id_credit_account], onDelete: Cascade)

  created_at DateTime  @default(now())
  value_date DateTime?
  concept    String
  amount     Decimal   @db.Decimal(18, 2)
  currency   String

  booking_id Int?
  booking    Booking? @relation(fields: [booking_id], references: [id_booking], onDelete: SetNull)

  receipt_id Int?
  receipt    Receipt? @relation(fields: [receipt_id], references: [id_receipt], onDelete: SetNull)

  investment_id Int?
  investment    Investment? @relation(fields: [investment_id], references: [id_investment], onDelete: SetNull)

  operator_due_id Int?
  operatorDue     OperatorDue? @relation(fields: [operator_due_id], references: [id_due], onDelete: SetNull)

  doc_type  String?
  reference String?

  created_by Int?
  createdBy  User? @relation(fields: [created_by], references: [id_user], onDelete: SetNull)

  @@index([account_id])
  @@index([id_agency, created_at])
  @@index([booking_id])
  @@index([receipt_id])
  @@index([investment_id])
  @@index([operator_due_id])
}
